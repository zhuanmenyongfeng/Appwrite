name: Auto Tar and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Validate required files
      run: |
        if [ ! -f "index.js" ]; then
          echo "âŒ index.js not found!"
          exit 1
        fi
        if [ ! -f "package.json" ]; then
          echo "âŒ package.json not found!"
          exit 1
        fi
        echo "âœ… Required files found"
        
    - name: Display file info
      run: |
        echo "ğŸ“‹ Files to be packaged:"
        echo "ğŸ“„ index.js ($(wc -l < index.js) lines, $(du -h index.js | cut -f1))"
        echo "ğŸ“„ package.json ($(du -h package.json | cut -f1))"
        echo ""
        echo "ğŸ“¦ Package.json content:"
        cat package.json
        
    - name: Create package directory
      run: |
        mkdir -p appwrite-functions
        
    - name: Copy files to package directory
      run: |
        cp index.js appwrite-functions/
        cp package.json appwrite-functions/
        echo "âœ… Files copied to package directory"
        
    - name: Create deployment archive
      run: |
        cd appwrite-functions
        tar -czf ../Appwrite-Functions.tar.gz index.js package.json
        cd ..
        echo "ğŸ“¦ Archive created: Appwrite-Functions.tar.gz"
        echo "ğŸ“Š Archive size: $(du -h Appwrite-Functions.tar.gz | cut -f1)"
        
    - name: Verify archive contents
      run: |
        echo "ğŸ” Archive contents:"
        tar -tzf Appwrite-Functions.tar.gz
        
    - name: Generate release notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## ğŸš€ Appwrite Functions éƒ¨ç½²åŒ…
        
        ### ğŸ“¦ åŒ…å«æ–‡ä»¶
        - `index.js` - ä¸»å‡½æ•°æ–‡ä»¶ï¼ˆé€‚é…Appwrite Functionsï¼‰
        - `package.json` - ä¾èµ–é…ç½®æ–‡ä»¶
        
        ### ğŸ› ï¸ éƒ¨ç½²æ­¥éª¤
        1. ä¸‹è½½ `Appwrite-Functions.tar.gz` å‹ç¼©åŒ…
        2. è§£å‹å¾—åˆ° `index.js` å’Œ `package.json`
        3. ç™»å½• [Appwrite æ§åˆ¶å°](https://cloud.appwrite.io)
        4. è¿›å…¥ Functions éƒ¨åˆ†ï¼Œåˆ›å»ºæ–°éƒ¨ç½²
        5. é€‰æ‹© Manual ä¸Šä¼ æ–¹å¼
        6. ä¸Šä¼ è§£å‹åçš„ä¸¤ä¸ªæ–‡ä»¶
        7. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå‚è€ƒ README.mdï¼‰
        8. ç­‰å¾…æ„å»ºå®Œæˆ
        
        ### âœ¨ åŠŸèƒ½ç‰¹æ€§
        - ğŸš€ å¤šåè®®ä»£ç†èŠ‚ç‚¹æ”¯æŒ
        - ğŸ“Š nezhaç›‘æ§é›†æˆ
        - ğŸ”¥ cloudflaredéš§é“æœåŠ¡
        - ğŸ“± Telegramæ¶ˆæ¯æ¨é€
        - ğŸŒ è‡ªåŠ¨è®¢é˜…ç”Ÿæˆ
        - ğŸ’š å¥åº·æ£€æŸ¥API
        - ğŸ”„ 301é‡å®šå‘åˆ°å¯¼èˆªç«™
        
        ### ğŸ“‹ ä¸»è¦ç¯å¢ƒå˜é‡
        - `UUID` - æœåŠ¡æ ‡è¯†ç¬¦
        - `NAME` - æœåŠ¡åç§°
        - `ARGO_DOMAIN` - Argoéš§é“åŸŸå
        - `ARGO_AUTH` - Argoè®¤è¯ä¿¡æ¯
        - `NEZHA_SERVER` - å“ªå’ç›‘æ§æœåŠ¡å™¨
        - `CHAT_ID` & `BOT_TOKEN` - Telegramæ¨é€é…ç½®
        
        > å®Œæ•´ç¯å¢ƒå˜é‡è¯´æ˜è¯·æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
        
        ### ğŸ”— APIç«¯ç‚¹
        - `GET /` - é‡å®šå‘åˆ°å¯¼èˆªç«™
        - `GET /sub` - è·å–è®¢é˜…é“¾æ¥
        - `GET /health` - ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
        
        ---
        
        â­ **å¿«é€Ÿå¼€å§‹**: ä¸‹è½½å‹ç¼©åŒ… â†’ è§£å‹ â†’ ä¸Šä¼ åˆ°Appwrite â†’ é…ç½®ç¯å¢ƒå˜é‡ â†’ éƒ¨ç½²å®Œæˆï¼
        EOF
        
    - name: Extract version from tag
      id: get_version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="latest"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“‹ Version: $VERSION"
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: "Appwrite Functions v${{ steps.get_version.outputs.version }}"
        body_path: release_notes.md
        files: |
          Appwrite-Functions.tar.gz
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Release Summary
      run: |
        echo "ğŸ‰ Release completed successfully!"
        echo "ğŸ“¦ Package: Appwrite-Functions.tar.gz"
        echo "ğŸ·ï¸ Version: ${{ steps.get_version.outputs.version }}"
        echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.version }}"
        echo ""
        echo "ğŸ“‹ Next steps:"
        echo "1. Download the Appwrite-Functions.tar.gz from the release"
        echo "2. Extract index.js and package.json"
        echo "3. Upload to Appwrite Functions"
        echo "4. Configure environment variables"
        echo "5. Deploy and test!"
