name: Build and Release Appwrite

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/main.js'
      - 'package.json'
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Validate required files
      run: |
        if [ ! -f "src/main.js" ]; then
          echo "âŒ main.js not found!"
          exit 1
        fi
        if [ ! -f "package.json" ]; then
          echo "âŒ package.json not found!"
          exit 1
        fi
        echo "âœ… Required files found"
        
    - name: Display file info
      run: |
        echo "ğŸ“‹ Files to be packaged:"
        echo "ğŸ“ src/ folder:"
        ls -la src/
        echo "ğŸ“„ src/main.js ($(wc -l < src/main.js) lines, $(du -h src/main.js | cut -f1))"
        echo "ğŸ“„ package.json ($(du -h package.json | cut -f1))"
        echo ""
        echo "ğŸ“¦ Package.json content:"
        cat package.json
        
    - name: Create package directory
      run: |
        mkdir -p appwrite-functions
        
    - name: Copy files to package directory
      run: |
        cp -r src/ appwrite-functions/
        cp package.json appwrite-functions/
        echo "âœ… Files copied to package directory"
        echo "ğŸ“ Package directory contents:"
        ls -la appwrite-functions/
        
    - name: Create deployment archive
      run: |
        cd appwrite-functions
        tar -czf ../Appwrite-Functions.tar.gz src/main.js package.json
        cd ..
        echo "ğŸ“¦ Archive created: Appwrite-Functions.tar.gz"
        echo "ğŸ“Š Archive size: $(du -h Appwrite-Functions.tar.gz | cut -f1)"
        
    - name: Verify archive contents
      run: |
        echo "ğŸ” Archive contents:"
        tar -tzf Appwrite-Functions.tar.gz
        
    - name: Auto-create version tag
      id: auto_tag
      run: |
        # è·å–å½“å‰æ—¶é—´ä½œä¸ºç‰ˆæœ¬å·
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        SHORT_SHA=$(git rev-parse --short HEAD)
        NEW_VERSION="v1.0.${TIMESTAMP}-${SHORT_SHA}"
        
        # åˆ›å»ºæ–°æ ‡ç­¾
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a $NEW_VERSION -m "Auto-generated version for changes in src/main.js or package.json"
        git push origin $NEW_VERSION
        
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ è‡ªåŠ¨åˆ›å»ºæ ‡ç­¾: $NEW_VERSION"
        
    - name: Generate release notes
      id: release_notes
      run: |
        # è·å–æœ€è¿‘çš„æäº¤ä¿¡æ¯
        LATEST_COMMIT=$(git log -1 --pretty=format:"%s")
        COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
        
        cat > release_notes.md << EOF
        ## ğŸš€ Appwrite Functions è‡ªåŠ¨éƒ¨ç½²åŒ…
        
        ### ğŸ“ æœ€è¿‘æ›´æ”¹
        - **æäº¤ä¿¡æ¯**: $LATEST_COMMIT
        - **ä½œè€…**: $COMMIT_AUTHOR
        - **è‡ªåŠ¨æ„å»ºæ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S")
        
        ### â­ ä½¿ç”¨è¯´æ˜
        1. ä¸‹è½½ä¸‹æ–¹çš„å‹ç¼©åŒ…
        2. åœ¨Appwriteæ§åˆ¶å°åˆ›å»ºFunction
        3. ä¸Šä¼ æ­¤å‹ç¼©åŒ…
        4. é…ç½®æ‰€éœ€çš„ç¯å¢ƒå˜é‡
        5. éƒ¨ç½²å¹¶æµ‹è¯•åŠŸèƒ½
        
        ### ğŸ“¦ åŒ…å«æ–‡ä»¶
        - src/main.js (ä¸»ç¨‹åºæ–‡ä»¶)
        - package.json (ä¾èµ–é…ç½®)
        
        *æ­¤ç‰ˆæœ¬ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*
        EOF
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.auto_tag.outputs.version }}
        name: "Appwrite Functions ${{ steps.auto_tag.outputs.version }}"
        body_path: release_notes.md
        files: Appwrite-Functions.tar.gz
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Release Summary
      run: |
        echo "ğŸ‰ è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒå®Œæˆ!"
        echo "ğŸ“¦ åŒ…æ–‡ä»¶: Appwrite-Functions.tar.gz"
        echo "ğŸ·ï¸ ç‰ˆæœ¬: ${{ steps.auto_tag.outputs.version }}"
        echo "ğŸ”— å‘å¸ƒåœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ steps.auto_tag.outputs.version }}"
        echo ""
        echo "ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ:"
        echo "1. å‰å¾€Releaseé¡µé¢ä¸‹è½½å‹ç¼©åŒ…"
        echo "2. åœ¨Appwriteä¸­åˆ›å»ºæˆ–æ›´æ–°Function"
        echo "3. ä¸Šä¼ ä¸‹è½½çš„å‹ç¼©åŒ…"
        echo "4. é…ç½®ç¯å¢ƒå˜é‡"
        echo "5. éƒ¨ç½²å¹¶æµ‹è¯•åŠŸèƒ½"
